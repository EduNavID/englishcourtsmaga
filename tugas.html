<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumpul Tugas - English Court</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display.swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9;
        }
        .nav-link-active {
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header (Sama seperti Beranda) -->
    <header class="bg-white/90 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="./beranda.html" class="flex items-center gap-3">
                <img src="https://i.imgur.com/vOlASeq.png" alt="Logo SMAN 3 Lamongan" class="h-12 w-12">
                <div class="h-12 w-12 rounded-full border-2 border-dashed border-slate-400 flex items-center justify-center">
                    <span class="text-xs font-semibold text-slate-500 text-center">EC Logo</span>
                </div>
                <span class="text-xl font-bold text-blue-700 hidden sm:block">English Court</span>
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="./beranda.html" class="text-slate-600 hover:text-blue-600 transition-colors">Beranda</a>
                <a href="#" class="text-slate-600 hover:text-blue-600 transition-colors">Materi</a>
                <a href="./tugas.html" class="nav-link-active">Tugas</a>
                <a href="#" class="text-slate-600 hover:text-blue-600 transition-colors">Pengumuman</a>
            </div>
            <div class="relative">
                <button id="profile-button" class="flex items-center gap-2 group">
                    <img id="profile-avatar" src="https://placehold.co/40x40/dbeafe/4338ca?text=U" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-slate-200 group-hover:border-blue-400 transition object-cover">
                </button>
            </div>
        </nav>
    </header>

    <!-- Konten Utama Halaman Tugas -->
    <main class="container mx-auto px-4 sm:px-6 py-8">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Daftar Tugas</h1>
            <p class="text-slate-600 mt-2">Silakan unggah file tugas Anda sebelum batas waktu yang ditentukan.</p>
        </div>

        <!-- Daftar Tugas -->
        <div id="assignment-list" class="space-y-4">
            <!-- Data tugas akan dimasukkan oleh JavaScript -->
        </div>
    </main>

    <!-- Elemen input file yang tersembunyi -->
    <input type="file" id="file-upload-input" class="hidden">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://jelcycdbdokcalsuptwm.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplbGN5Y2RiZG9rY2Fsc3VwdHdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTM0NTUsImV4cCI6MjA3MDA2OTQ1NX0.tjgC8FKPb8L3T84V5EyRg5KSc23zr0Kcb0w5VsP4d6I';
            
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

            const assignmentListContainer = document.getElementById('assignment-list');
            const fileUploadInput = document.getElementById('file-upload-input');
            let currentUserEmail = '';

            // --- DATA TUGAS (Untuk sementara, nanti bisa diambil dari database) ---
            const assignments = [
                { id: 1, title: 'Essay: The Importance of English', dueDate: '2025-08-15' },
                { id: 2, title: 'Presentation: My Favorite Movie', dueDate: '2025-08-22' },
                { id: 3, title: 'Poem Analysis: "The Road Not Taken"', dueDate: '2025-08-30' },
            ];

            // --- FUNGSI UTAMA ---
            async function initializePage() {
                const { data, error } = await supabaseClient.auth.getSession();
                if (error || !data.session) {
                    window.location.href = './index.html';
                    return;
                }
                currentUserEmail = data.session.user.email;
                
                // Ambil data pengumpulan yang sudah ada
                const { data: submissions, error: submissionsError } = await supabaseClient
                    .from('submissions')
                    .select('assignment_title')
                    .eq('user_email', currentUserEmail);

                const submittedTitles = submissions ? submissions.map(s => s.assignment_title) : [];
                
                renderAssignments(submittedTitles);
            }

            function renderAssignments(submittedTitles) {
                assignmentListContainer.innerHTML = ''; // Kosongkan daftar
                assignments.forEach(assignment => {
                    const isSubmitted = submittedTitles.includes(assignment.title);
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
                    
                    card.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">${assignment.title}</h3>
                            <p class="text-sm text-slate-500">Batas Waktu: ${assignment.dueDate}</p>
                        </div>
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div id="status-${assignment.id}" class="text-sm font-semibold ${isSubmitted ? 'text-green-600' : 'text-red-600'}">
                                ${isSubmitted ? '✔ Terkumpul' : '✖ Belum Mengumpulkan'}
                            </div>
                            <button id="upload-btn-${assignment.id}" data-title="${assignment.title}" class="upload-button w-full sm:w-auto px-4 py-2 text-sm font-bold text-white rounded-lg transition-colors ${isSubmitted ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" ${isSubmitted ? 'disabled' : ''}>
                                ${isSubmitted ? 'Terkumpul' : 'Kumpul Tugas'}
                            </button>
                        </div>
                    `;
                    assignmentListContainer.appendChild(card);
                });

                // Tambahkan event listener ke semua tombol upload
                document.querySelectorAll('.upload-button').forEach(button => {
                    button.addEventListener('click', () => {
                        if (!button.disabled) {
                            // Simpan judul tugas yang sedang di-upload
                            fileUploadInput.dataset.assignmentTitle = button.dataset.title;
                            fileUploadInput.click(); // Buka dialog pilih file
                        }
                    });
                });
            }
            
            async function handleFileUpload(event) {
                const file = event.target.files[0];
                const assignmentTitle = event.target.dataset.assignmentTitle;
                if (!file || !assignmentTitle) return;

                const uploadButton = document.querySelector(`button[data-title="${assignmentTitle}"]`);
                const statusDiv = document.getElementById(`status-${assignments.find(a => a.title === assignmentTitle).id}`);

                uploadButton.disabled = true;
                uploadButton.textContent = 'Mengunggah...';

                try {
                    // Membuat nama file yang unik
                    const fileName = `${currentUserEmail.split('@')[0]}_${assignmentTitle.replace(/ /g, '_')}_${Date.now()}`;
                    
                    // 1. Upload file ke Supabase Storage
                    const { data: uploadData, error: uploadError } = await supabaseClient
                        .storage
                        .from('file-tugas') // Nama bucket yang Anda buat
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    // 2. Dapatkan URL publik dari file yang di-upload
                    const { data: urlData } = supabaseClient
                        .storage
                        .from('file-tugas')
                        .getPublicUrl(fileName);

                    const publicURL = urlData.publicUrl;

                    // 3. Simpan catatan ke database
                    const { error: insertError } = await supabaseClient
                        .from('submissions')
                        .insert({
                            user_email: currentUserEmail,
                            assignment_title: assignmentTitle,
                            file_url: publicURL
                        });
                    
                    if (insertError) throw insertError;

                    // Update UI jika berhasil
                    alert('Tugas berhasil dikumpulkan!');
                    statusDiv.textContent = '✔ Terkumpul';
                    statusDiv.className = 'text-sm font-semibold text-green-600';
                    uploadButton.textContent = 'Terkumpul';
                    uploadButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    uploadButton.classList.add('bg-gray-400', 'cursor-not-allowed');

                } catch (error) {
                    alert(`Gagal mengumpulkan tugas: ${error.message}`);
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'Kumpul Tugas';
                } finally {
                    // Reset input file agar bisa upload file yang sama lagi jika perlu
                    fileUploadInput.value = ''; 
                }
            }

            // --- INISIALISASI ---
            fileUploadInput.addEventListener('change', handleFileUpload);
            initializePage();
        });
    </script>
</body>
</html>
